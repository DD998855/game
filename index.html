<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <title>å±äºä½ çš„å°åœ£è¯æ ‘ ğŸ„</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont;
      background: #f5f5f5;
      margin: 0;
      padding: 40px 16px;
      text-align: center;
    }

    h1 {
      margin-bottom: 16px;
    }

    .btns {
      margin-bottom: 12px;
    }

    button {
      padding: 10px 16px;
      margin: 6px;
      border-radius: 8px;
      border: 1px solid #ccc;
      background: #fff;
      cursor: pointer;
      font-size: 14px;
    }

    button:disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }

    .hint {
      color: #666;
      font-size: 13px;
      margin-bottom: 16px;
    }

    #preview {
      width: 320px;
      max-width: 90%;
      border-radius: 12px;
      margin: 20px auto;
      display: none;
    }

    /* ===== å¼¹çª— ===== */
    .mask {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.55);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 10;
    }

    .modal {
      width: 340px;
      background: #fff;
      border-radius: 14px;
      padding: 16px;
      text-align: center;
    }

    .modal h3 {
      margin-top: 0;
    }

    .modal img {
      width: 200px;
      border-radius: 8px;
      margin: 10px 0;
    }

    .modal input {
      width: 90%;
      padding: 8px;
      font-size: 14px;
      margin-bottom: 8px;
    }

    .error {
      color: red;
      font-size: 13px;
      margin-top: 6px;
    }
  </style>
</head>

<body>

  <h1>ğŸ„ å±äºä½ çš„å°åœ£è¯æ ‘ ğŸ„</h1>

  <div class="btns">
    <button id="btnGenerate">ç”Ÿæˆï¼ˆåªèƒ½ä¸€æ¬¡ï¼‰</button>
    <button id="btnSaveFree" disabled>ä¿å­˜ï¼ˆæœ‰æ°´å°ï¼‰</button>
    <button id="btnOpenPay" disabled>å»æ°´å°ï¼ˆå…‘æ¢ç ï¼‰</button>
    <button id="btnSavePaid" disabled>ä¿å­˜ï¼ˆæ— æ°´å°ï¼‰</button>
  </div>

  <div class="hint">
    æç¤ºï¼šå…ˆç”Ÿæˆ â†’ å…è´¹å¯ä¿å­˜æœ‰æ°´å°ï¼›è¾“å…¥å…‘æ¢ç åå¯è§£é”æ— æ°´å°ä¸‹è½½
  </div>

  <img id="preview" />

  <!-- ===== å…‘æ¢å¼¹çª— ===== -->
  <div class="mask" id="mask">
    <div class="modal">
      <h3>âœ… ä»˜è´¹å»æ°´å°ï¼ˆå…‘æ¢ç ï¼‰</h3>

      <p style="font-size:13px;color:#555">
        1ï¸âƒ£ æ‰«ç ä»˜æ¬¾ï¼ˆç¤ºæ„ï¼‰<br>
        2ï¸âƒ£ è·å¾—å…‘æ¢ç ï¼ˆå¦‚ï¼šCINDY-0001ï¼‰<br>
        3ï¸âƒ£ è¾“å…¥å…‘æ¢ç è§£é”æ— æ°´å°ä¸‹è½½
      </p>

      <!-- ä½ çš„ä»˜æ¬¾ç å›¾ç‰‡ -->
      <img src="img/money/0.jpg" alt="å¾®ä¿¡ä»˜æ¬¾ç ">

      <input id="codeInput" placeholder="è¾“å…¥å…‘æ¢ç ï¼Œå¦‚ CINDY-0001" />
      <br>

      <button id="btnRedeem">éªŒè¯å…‘æ¢ç </button>
      <button onclick="closeModal()">å…³é—­</button>

      <div class="error" id="errorMsg"></div>
    </div>
  </div>

<script>
/* ===============================
   ğŸ”§ é…ç½®ï¼šåªæ”¹è¿™é‡Œå°±å¤Ÿäº†
================================ */
const API_BASE = "https://test-rgqf.onrender.com"; 
// â†‘â†‘â†‘ æŠŠè¿™è¡Œæ”¹æˆä½  Render çš„çœŸå®åœ°å€ï¼ˆä¸è¦ä»¥ / ç»“å°¾ï¼‰

/* ===============================
   é¡µé¢çŠ¶æ€
================================ */
let generated = false;
let unlocked = false;

// ä½ ç°åœ¨â€œç”Ÿæˆâ€å†™æ­»ç”¨ free/1.1.pngï¼Œæ‰€ä»¥è¿™é‡Œè®©æ— æ°´å°å¯¹åº” 1.jpg
let currentImg = "1.jpg"; // paid/img_paid/1.jpg

/* ===============================
   DOM
================================ */
const preview = document.getElementById("preview");
const btnGenerate = document.getElementById("btnGenerate");
const btnSaveFree = document.getElementById("btnSaveFree");
const btnOpenPay = document.getElementById("btnOpenPay");
const btnSavePaid = document.getElementById("btnSavePaid");

const mask = document.getElementById("mask");
const errorMsg = document.getElementById("errorMsg");

/* ===============================
   ç”Ÿæˆï¼ˆç¤ºä¾‹ï¼šå›ºå®šç¬¬ä¸€å¼ ï¼‰
================================ */
btnGenerate.onclick = () => {
  if (generated) return;

  generated = true;

  // âœ… è¿™é‡Œæ˜¾ç¤ºâ€œæœ‰æ°´å°â€çš„å›¾ï¼ˆä½ çš„ free ç›®å½•ï¼‰
  preview.src = "img/free/1.1.png";
  preview.style.display = "block";

  btnSaveFree.disabled = false;
  btnOpenPay.disabled = false;
  btnGenerate.disabled = true;
};

/* ===============================
   ä¿å­˜ï¼ˆæœ‰æ°´å°ï¼‰
================================ */
btnSaveFree.onclick = () => {
  download(preview.src, "christmas_free.png");
};

/* ===============================
   æ‰“å¼€å…‘æ¢å¼¹çª—
================================ */
btnOpenPay.onclick = () => {
  errorMsg.textContent = "";
  mask.style.display = "flex";
};

/* ===============================
   å…³é—­å¼¹çª—
================================ */
function closeModal() {
  mask.style.display = "none";
}

/* ===============================
   Redeemï¼šæ ¸å¿ƒé€»è¾‘
================================ */
document.getElementById("btnRedeem").onclick = async () => {
  const code = document.getElementById("codeInput").value.trim();

  if (!code) {
    errorMsg.textContent = "è¯·è¾“å…¥å…‘æ¢ç ";
    return;
  }

  errorMsg.textContent = "éªŒè¯ä¸­â€¦";

  try {
    // âœ… é‡è¦ï¼šè¯·æ±‚ Render åç«¯ï¼Œè€Œä¸æ˜¯æœ¬åŸŸå
    const res = await fetch(`${API_BASE}/redeem`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ code, img: currentImg })
    });

    const data = await res.json().catch(() => ({}));

    if (!res.ok || !data.ok) {
      errorMsg.textContent = (data && data.msg) ? data.msg : `å…‘æ¢å¤±è´¥ï¼ˆHTTP ${res.status}ï¼‰`;
      return;
    }

    // âœ… æˆåŠŸ
    unlocked = true;
    btnSavePaid.disabled = false;
    btnOpenPay.disabled = true;

    // ä¿å­˜ token ä¾›ä¸‹è½½ç”¨
    window.__TOKEN__ = data.token;

    closeModal();
    alert("ğŸ‰ å…‘æ¢æˆåŠŸï¼å·²è§£é”æ— æ°´å°ä¸‹è½½ï¼ˆ5åˆ†é’Ÿå†…æœ‰æ•ˆï¼Œä»…ä¸€æ¬¡ï¼‰");

  } catch (e) {
    errorMsg.textContent = "ç½‘ç»œé”™è¯¯ï¼šæ— æ³•è®¿é—®åç«¯ï¼ˆæ£€æŸ¥ Render æ˜¯å¦åœ¨çº¿/åœ°å€æ˜¯å¦æ­£ç¡®ï¼‰";
  }
};

/* ===============================
   ä¸‹è½½æ— æ°´å°
================================ */
btnSavePaid.onclick = () => {
  if (!window.__TOKEN__) {
    alert("token ä¸¢å¤±ï¼Œè¯·é‡æ–°å…‘æ¢");
    return;
  }

  // âœ… é‡è¦ï¼šä¸‹è½½ä¹Ÿå¿…é¡»èµ° Render åç«¯
  const url = `${API_BASE}/download?token=${encodeURIComponent(window.__TOKEN__)}&img=${encodeURIComponent(currentImg)}`;

  // ç›´æ¥è·³è½¬ä¸‹è½½
  window.location.href = url;
};

/* ===============================
   å·¥å…·ï¼šä¸‹è½½
================================ */
function download(url, filename) {
  const a = document.createElement("a");
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
}
</script>


</body>
</html>
