<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>åœ£è¯æ ‘ç”Ÿæˆå™¨</title>
  <style>
    body{font-family:Arial,sans-serif;margin:0;padding:24px 16px;text-align:center;}
    h1{margin:8px 0 18px;}
    .btns{display:flex;gap:14px;justify-content:center;flex-wrap:wrap;margin:10px 0 8px;}
    button{font-size:16px;padding:10px 16px;border:1px solid #999;background:#fff;border-radius:8px;cursor:pointer;}
    button:disabled{opacity:.45;cursor:not-allowed;}
    .hint{color:#666;font-size:13px;margin-top:6px;}
    #previewWrap{margin-top:18px;}
    #preview{width:360px;max-width:90vw;border-radius:12px;display:none;margin:0 auto;}
    /* å¼¹çª— */
    .mask{position:fixed;left:0;top:0;right:0;bottom:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;padding:16px;}
    .modal{width:min(520px,95vw);background:#fff;border-radius:14px;padding:18px 16px 14px;text-align:left;}
    .modal h2{margin:0 0 8px;font-size:18px;}
    .steps{font-size:13px;color:#555;line-height:1.55;margin-bottom:10px;}
    .qr{width:260px;max-width:75vw;border-radius:12px;display:block;margin:10px auto;}
    .row{display:flex;gap:10px;justify-content:center;align-items:center;flex-wrap:wrap;margin-top:10px;}
    input{font-size:14px;padding:10px 12px;border:1px solid #bbb;border-radius:10px;width:220px;}
    .small{font-size:12px;color:#999;margin-top:8px;text-align:center;}
    .error{color:#c00;font-size:12px;margin-top:8px;text-align:center;}
  </style>
</head>

<body>
  <h1>ğŸ„ å±äºä½ çš„å°åœ£è¯æ ‘ ğŸ„</h1>

  <div class="btns">
    <button id="genBtn" onclick="generateTree()">ç”Ÿæˆï¼ˆåªèƒ½ä¸€æ¬¡ï¼‰</button>
    <button id="downloadFreeBtn" onclick="downloadFree()" disabled>ä¿å­˜ï¼ˆæœ‰æ°´å°ï¼‰</button>
    <button id="payBtn" onclick="openPayModal()" disabled>å»æ°´å°ï¼ˆå…‘æ¢ç ï¼‰</button>
    <button id="downloadPaidBtn" onclick="downloadPaid()" disabled>ä¿å­˜ï¼ˆæ— æ°´å°ï¼‰</button>
  </div>

  <div class="hint">æç¤ºï¼šå…ˆç”Ÿæˆ â†’ å…è´¹å¯ä¿å­˜æœ‰æ°´å°ï¼›ä»˜è´¹åè¾“å…¥å…‘æ¢ç ï¼Œå¯è§£é”æ— æ°´å°ä¸‹è½½ï¼ˆå…ˆæŠŠ redeem è·‘é€šï¼‰ã€‚</div>

  <div id="previewWrap">
    <img id="preview" alt="é¢„è§ˆå›¾" />
  </div>

  <!-- æ”¯ä»˜/å…‘æ¢ç  å¼¹çª— -->
  <div class="mask" id="mask">
    <div class="modal">
      <h2>âœ… ä»˜è´¹å»æ°´å°ï¼ˆå…‘æ¢ç ï¼‰</h2>
      <div class="steps">
        1ï¼‰å…ˆæ‰«ç ä»˜æ¬¾ï¼ˆç¤ºæ„ï¼‰<br>
        2ï¼‰ä½ ä¼šæ”¶åˆ°ä¸€ä¸ªâ€œå…‘æ¢ç â€ï¼ˆæ¯”å¦‚ï¼šCINDY-0001ï¼‰<br>
        3ï¼‰æŠŠå…‘æ¢ç å¡«åœ¨ä¸‹é¢ï¼Œç‚¹â€œéªŒè¯å…‘æ¢ç â€ï¼ŒéªŒè¯æˆåŠŸåè§£é”æ— æ°´å°ä¸‹è½½
      </div>

      <img class="qr" src="img/money/0.jpg" alt="ä»˜æ¬¾ç ">

      <div class="row">
        <input id="codeInput" placeholder="è¾“å…¥å…‘æ¢ç ï¼Œå¦‚ CINDY-0001" />
        <button id="redeemBtn" onclick="redeemCode()">éªŒè¯å…‘æ¢ç </button>
        <button onclick="closePayModal()">å…³é—­</button>
      </div>

      <div class="small">ï¼ˆç°åœ¨å…ˆè·‘é€šï¼šè¾“å…¥ CINDY-0001 â†’ æˆåŠŸ â†’ è§£é”â€œä¿å­˜ï¼ˆæ— æ°´å°ï¼‰â€æŒ‰é’®ï¼‰</div>
      <div class="error" id="redeemMsg"></div>
    </div>
  </div>

  <script>
    // ä½ çš„æ–‡ä»¶å‘½åè§„åˆ™ï¼š
    // free(æœ‰æ°´å°): img/free/1.1.png ... 10.1.png
    // paid(æ— æ°´å°): paid/img_paid/1.jpg ... 10.jpg  ï¼ˆæ³¨æ„ï¼šæ— æ°´å°ä¸ç›´æ¥æš´éœ²åœ¨å‰ç«¯ï¼‰
    const imagesFree = Array.from({ length: 10 }, (_, i) => `img/free/${i + 1}.1.png`);

    let selectedIndex = -1;        // 0~9
    let selectedPaidName = "";     // e.g. "6.jpg"
    let redeemedToken = "";        // åç«¯è¿”å›çš„ä¸€æ¬¡æ€§ token
    let generated = false;

    const preview = document.getElementById("preview");
    const genBtn = document.getElementById("genBtn");
    const downloadFreeBtn = document.getElementById("downloadFreeBtn");
    const payBtn = document.getElementById("payBtn");
    const downloadPaidBtn = document.getElementById("downloadPaidBtn");

    // é˜²æ­¢åå›¾æ ‡ï¼šåŠ è½½å¤±è´¥å°±éšè—
    preview.onerror = () => { preview.style.display = "none"; };

    function generateTree() {
      if (generated) return;

      selectedIndex = Math.floor(Math.random() * imagesFree.length);
      const freeSrc = imagesFree[selectedIndex];

      // æ˜¾ç¤ºæœ‰æ°´å°é¢„è§ˆ
      preview.src = freeSrc;
      preview.style.display = "block";

      // è®¡ç®—å¯¹åº”æ— æ°´å°æ–‡ä»¶åï¼ˆåŒä¸€ç¼–å·ï¼‰
      selectedPaidName = `${selectedIndex + 1}.jpg`;

      generated = true;
      genBtn.disabled = true;

      downloadFreeBtn.disabled = false;
      payBtn.disabled = false;

      // ç”Ÿæˆåï¼Œå…ˆé”ä½æ— æ°´å°æŒ‰é’®ï¼Œå¿…é¡» redeem æˆåŠŸæ‰å¼€
      downloadPaidBtn.disabled = true;
      redeemedToken = "";
    }

    function downloadFree() {
      if (selectedIndex < 0) return;
      const a = document.createElement("a");
      a.href = imagesFree[selectedIndex];
      a.download = `christmas_free_${selectedIndex + 1}.png`;
      document.body.appendChild(a);
      a.click();
      a.remove();
    }

    // ===== å¼¹çª— =====
    function openPayModal() {
      document.getElementById("redeemMsg").textContent = "";
      document.getElementById("codeInput").value = "";
      document.getElementById("mask").style.display = "flex";
    }
    function closePayModal() {
      document.getElementById("mask").style.display = "none";
    }

    // ===== redeemï¼šæŠŠå…‘æ¢ç å‘ç»™åç«¯ï¼Œåç«¯è¿”å› token =====
    async function redeemCode() {
      const msg = document.getElementById("redeemMsg");
      msg.textContent = "";

      const code = document.getElementById("codeInput").value.trim();
      if (!generated || !selectedPaidName) {
        msg.textContent = "è¯·å…ˆç”Ÿæˆä¸€å¼ åœ£è¯æ ‘ï¼Œå†æ¥å…‘æ¢ã€‚";
        return;
      }
      if (!code) {
        msg.textContent = "è¯·è¾“å…¥å…‘æ¢ç ã€‚";
        return;
      }

      try {
        const resp = await fetch("/redeem", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ code, img: selectedPaidName })
        });

        const data = await resp.json().catch(() => ({}));
        if (!resp.ok || !data.ok) {
          msg.textContent = data.msg || "å…‘æ¢å¤±è´¥ï¼ˆè¯·æ£€æŸ¥ server.js æ˜¯å¦è¿è¡Œ / å…‘æ¢ç æ˜¯å¦æ­£ç¡®ï¼‰";
          return;
        }

        redeemedToken = data.token;
        msg.style.color = "#0a7";
        msg.textContent = "âœ… å…‘æ¢æˆåŠŸï¼å·²è§£é”æ— æ°´å°ä¸‹è½½ã€‚";

        downloadPaidBtn.disabled = false;
        closePayModal();
      } catch (e) {
        msg.style.color = "#c00";
        msg.textContent = "ç½‘ç»œé”™è¯¯ï¼šè¯·ç¡®è®¤ä½ æ˜¯é€šè¿‡ node server.js æ‰“å¼€çš„é¡µé¢ï¼ˆä¸æ˜¯ Live Serverï¼‰ã€‚";
      }
    }

    // ===== ä¸‹è½½æ— æ°´å°ï¼šèµ°åç«¯ /download?token=...&img=... =====
    function downloadPaid() {
      if (!redeemedToken || !selectedPaidName) return;
      const url = `/download?token=${encodeURIComponent(redeemedToken)}&img=${encodeURIComponent(selectedPaidName)}`;
      window.location.href = url; // è§¦å‘ä¸‹è½½
      // æ³¨æ„ï¼štoken æ˜¯ä¸€æ¬¡æ€§çš„ï¼Œä½ ç‚¹ç¬¬äºŒæ¬¡ä¼šå¤±è´¥ï¼ˆè¿™æ˜¯æˆ‘ä»¬æƒ³è¦çš„ï¼‰
      downloadPaidBtn.disabled = true;
    }
  </script>
</body>
</html>
